// https://docs.cypress.io/api/introduction/api.html

// Used constants
const candilibAddress = 'http://localhost:8080/candilib/'

const inspecteur = 'DUPONT01DU75'
const inspecteur2 = 'DUPONT02DU75'
const matricule = '7501020305'
const matricule2 = '7501020306'
const emailInspecteur = 'dupont02du75.jacques@email.fr' // inspecteur2's email
const emailRepartiteur = 'email75@departement.com'

const candidat = 'CANDIDAT' // All uppercase
const emailCandidat = 'c@c.li'

const centre = 'Noisy le Grand'
const placeDate = '2019-10-08'
const datePlace = '08/10/19'

const email = 'jean@dupont.fr' // Any correct (not already whitelisted) email

// The admin should have access to 93 and 75
const adminLogin = 'admin@example.com'
const adminPass = 'Admin*78'

// Initialise magicLink
var magicLink

describe('Setup', () => {
  it('Creates the aurige files with the right content', () => {
    cy.writeFile('tests/e2e/files/aurige.json',
      [
        {
          'codeNeph': '0123456789',
          'nomNaissance': candidat,
          'email': emailCandidat,
          'dateReussiteETG': '2018-10-12',
          'nbEchecsPratiques': '0',
          'dateDernierNonReussite': '',
          'objetDernierNonReussite': '',
          'reussitePratique': '',
          'candidatExistant': 'OK',
        },
        {
          'codeNeph': '093621795384',
          'nomNaissance': 'GOOSE',
          'prenom': 'JIM',
          'email': 'jimgoose@candilib.com',
          'dateReussiteETG': '2012-11-11',
          'nbEchecsPratiques': '3',
          'dateDernierNonReussite': '2017-06-18',
          'objetDernierNonReussite': 'echec',
          'reussitePratique': '',
          'candidatExistant': 'OK',
        },
      ])
    cy.writeFile('tests/e2e/files/aurige.end.json',
      [
        {
          'codeNeph': '0123456789',
          'nomNaissance': candidat,
          'email': emailCandidat,
          'dateReussiteETG': '',
          'nbEchecsPratiques': '',
          'dateDernierNonReussite': '',
          'objetDernierNonReussite': '',
          'reussitePratique': '',
          'candidatExistant': 'NOK',
        },
      ])
  })

  it('Creates the planning file', () => {
    cy.writeFile('tests/e2e/files/planning.csv',
      'Date,Heure,Inspecteur,Non,Centre,Departement\n' +
    datePlace + ',08:00,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',08:30,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',09:00,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',09:30,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',10:00,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',10:30,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',11:00,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',11:30,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',12:00,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',12:30,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',13:00,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',13:30,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',14:00,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',14:30,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',15:00,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',15:30,' + matricule + ',' + inspecteur + ',' + centre + ',75\n' +
    datePlace + ',08:00,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',08:30,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',09:00,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',09:30,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',10:00,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',10:30,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',11:00,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',11:30,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',12:00,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',12:30,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',13:00,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',13:30,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',14:00,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',14:30,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',15:00,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75\n' +
    datePlace + ',15:30,' + matricule2 + ',' + inspecteur2 + ',' + centre + ',75'
    )
  })

  it('Adds the emails to the whitelist', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // Visits the whitelist
    cy.visit(candilibAddress + 'admin/whitelist')
    cy.get('h2')
      .should('contain', 'Liste blanche')
    // Adds the email
    cy.contains('Ajouter un lot d\'adresse courriel')
      .click()
    cy.get('#whitelist-batch-textarea')
      .type(emailCandidat + '\ntoecutter@candilib.com\njimgoose@candilib.com')
    cy.contains('Enregistrer ces adresses')
      .click()
  })

  it('Loads the places from the csv', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    cy.contains('calendar_today')
      .click()
    cy.get('.t-import-places [type=checkbox]')
      .check({ force: true })
    const filePath = '../files/planning.csv'
    const fileName = 'planning.csv'
    cy.fixture(filePath).then(fileContent => {
      cy.get('[type=file]').upload({ fileContent, fileName, mimeType: 'text/csv' })
    })
    cy.get('.v-snack')
      .should('contain', 'planning.csv prêt à être synchronisé')
    cy.get('.import-file-action [type=button]')
      .click({ force: true })
    cy.get('.v-snack', { timeout: 10000 })
      .should('contain', 'Le fichier planning.csv a été traité pour le departement 75.')
  })
})

describe('Subscription', () => {
  it('Fills the pre-sign-up form', () => {
    cy.visit(candilibAddress + 'qu-est-ce-que-candilib')
    cy.contains('Se pré-inscrire')
      .click()
    cy.get('h2')
      .should('contain', 'Réservez votre place d\'examen')
    cy.contains('NEPH')
      .parent()
      .children('input')
      .type('0123456789')
    cy.contains('Nom de naissance')
      .parent()
      .children('input')
      .type(candidat)
    cy.contains('Prénom')
      .parent()
      .children('input')
      .type('Jean')
    cy.contains('Courriel *')
      .parent()
      .children('input')
      .type(emailCandidat)
    cy.contains('Portable')
      .parent()
      .children('input')
      .type('0716253443')
    cy.contains('Adresse')
      .parent()
      .children('input')
      .type('avenue')
    cy.get('.v-select-list')
      .contains('avenue')
      .click()
    cy.contains('Pré-inscription')
      .click()
    // Verifies the access
    cy.url()
      .should('contain', 'email-validation')
    cy.get('h3')
      .should('contain', 'Validation en attente')
    cy.get('div')
      .should('contain', 'Vous allez bientôt recevoir un courriel à l\'adresse que vous nous avez indiqué.')
    cy.contains('Retour au formulaire de pré-inscription')
      .click()
  })

  it('Tries to pre-sign-up again', () => {
    cy.visit(candilibAddress + 'qu-est-ce-que-candilib')
    cy.contains('Se pré-inscrire')
      .click()
    cy.get('h2')
      .should('contain', 'Réservez votre place d\'examen')
    cy.contains('NEPH')
      .parent()
      .children('input')
      .type('0123456789')
    cy.contains('Nom de naissance')
      .parent()
      .children('input')
      .type(candidat)
    cy.contains('Prénom')
      .parent()
      .children('input')
      .type('Jean')
    cy.contains('Courriel *')
      .parent()
      .children('input')
      .type(emailCandidat)
    cy.contains('Portable')
      .parent()
      .children('input')
      .type('0716253443')
    cy.contains('Adresse')
      .parent()
      .children('input')
      .type('avenue')
    cy.get('.v-select-list')
      .contains('avenue')
      .click()
    cy.contains('Pré-inscription')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Cette adresse courriel est déjà enregistrée')
  })

  it('Gets the confirmation email from mailHog', () => {
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', 'Validation d\'adresse email pour Candilib')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody().then((mailBody) => {
        const codedLink = mailBody.split('href=3D"')[1].split('">')[0]
        const withoutEq = codedLink.replace(/=\r\n/g, '')
        const validationLink = withoutEq.replace(/=3D/g, '=')
        cy.visit(validationLink)
      })
    cy.get('h3')
      .should('contain', 'Adresse courriel validée')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Inscription_Candilib_en_attente_de_v?= =?UTF-8?Q?=C3=A9rification?=')
  })

  it('Visits the candidate already sign-up form when awaiting validation', () => {
    cy.visit(candilibAddress + 'qu-est-ce-que-candilib')
    cy.get('.t-already-signed-up-button-top')
      .should('contain', 'Déjà Inscrit ?')
      .click()
    cy.get('.t-magic-link-input-top [type=text]')
      .type(emailCandidat)
    cy.get('.t-magic-link-button-top')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Utilisateur en attente de validation.')
  })

  it('Validates the candidate via Aurige', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // Goes to the page
    cy.contains('import_export')
      .click()
    // Verifies that there is nothing
    cy.get('.ag-overlay')
      .should('contain', 'No Rows To Show')
    // Uploads the JSON file
    const filePath = '../files/aurige.json'
    const fileName = 'aurige.json'
    cy.fixture(filePath).then(fileContent => {
      cy.get('.input-file-container [type=file]')
        .upload({
          fileContent: JSON.stringify(fileContent),
          fileName,
          mimeType: 'application/json',
        })
    })
    cy.get('.v-snack')
      .should('contain', 'aurige.json prêt à être synchronisé')
    cy.get('.import-file-action [type=button]')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Le fichier aurige.json a été synchronisé.')
    // Verifies that the candidate is present
    cy.get('.ag-cell')
      .should('contain', candidat)
    cy.get('.ag-cell')
      .should('contain', 'Pour le 75, envoi d\'un magic link à ' + emailCandidat)
    cy.mhGetMailsByRecipient(emailCandidat)
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Validation_de_votre_inscription_=C3=A0_C?= =?UTF-8?Q?andilib?=')
  })

  it('Sends the magic link', () => {
    cy.visit(candilibAddress + 'qu-est-ce-que-candilib')
    cy.get('.t-already-signed-up-button-top')
      .should('contain', 'Déjà Inscrit ?')
      .click()
    cy.get('.t-magic-link-input-top [type=text]')
      .type(emailCandidat)
    cy.get('.t-magic-link-button-top')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Un lien de connexion vous a été envoyé.')
  })

  it('Gets the candidate magic link', () => {
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Validation_de_votre_inscription_=C3=A0_C?= =?UTF-8?Q?andilib?=')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody().then((mailBody) => {
        const codedLink = mailBody.split('href=3D"')[1].split('">')[0]
        const withoutEq = codedLink.replace(/=\r\n/g, '')
        magicLink = withoutEq.replace(/=3D/g, '=')
      })
  })
})

describe('Candidate front', () => {
  it('Tests the candidate front', () => {
    cy.visit(magicLink)
    // Tests the FAQ
    cy.contains('help_outline')
      .click()
    cy.url()
      .should('contain', 'faq')
    cy.get('h2')
      .should('contain', 'F.A.Q')
    cy.get('.question-content')
      .should('not.be.visible')
    cy.get('.question').contains('?')
      .click()
    cy.get('.question-content')
      .should('be.visible')
    // Tests the 'Mentions Légales' page
    cy.contains('account_balance')
      .click()
    cy.url()
      .should('contain', 'mentions-legales')
    cy.get('h2')
      .should('contain', 'Mentions légales')
    // Tests the profile page
    cy.contains('supervised_user_circle')
      .click()
    cy.url()
      .should('contain', 'mon-profil')
    cy.get('h2')
      .should('contain', 'Mon profil')
    cy.contains('Nom de naissance')
      .parent().parent()
      .should('contain', candidat)
    // Adds the reservation
    cy.contains('home')
      .click()
    cy.get('h2')
      .should('contain', 'Choix du centre')
    cy.contains(centre)
      .click()
    cy.get('.v-tabs .primary--text')
      .click()
    cy.contains(' ' + placeDate.split('-')[2] + ' ')
      .parents('.v-list__group')
      .within(($date) => {
        cy.root().click()
        cy.contains('08h00-08h30')
          .click()
      })
    cy.get('h2')
      .should('contain', 'Confirmation')
    cy.get('h3')
      .should('contain', centre)
    cy.get('[type=checkbox]')
      .first().check({ force: true })
    cy.get('[type=checkbox]')
      .last().check({ force: true })
    cy.get('button')
      .contains('Confirmer')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Votre réservation a bien été prise en compte')
    cy.get('h2')
      .should('contain', 'Ma réservation')
    cy.get('h3')
      .should('contain', centre)
    cy.get('p')
      .should('contain', 'à 08:00')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Convocation_=C3=A0_l=27examen_pratique_d?= =?UTF-8?Q?u_permis_de_conduire?=')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody()
      .should('contain', centre.toUpperCase())
      .and('contain', '8:00')
    // Changes the reservation
    cy.contains('Modifier ma réservation')
      .click()
    cy.contains(centre)
      .click()
    cy.get('.v-tabs .primary--text')
      .click()
    cy.contains(' ' + placeDate.split('-')[2] + ' ')
      .parents('.v-list__group')
      .within(($date) => {
        cy.root().click()
        cy.contains('08h30-09h00')
          .click()
      })
    cy.get('h2')
      .should('contain', 'Confirmer la modification')
    cy.get('h3')
      .should('contain', centre)
    cy.get('[type=checkbox]')
      .first().check({ force: true })
    cy.get('[type=checkbox]')
      .last().check({ force: true })
    cy.get('button')
      .contains('Confirmer')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Votre réservation a bien été prise en compte')
    cy.get('h2')
      .should('contain', 'Ma réservation')
    cy.get('h3')
      .should('contain', centre)
    cy.get('p')
      .should('contain', 'à 08:30')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Convocation_=C3=A0_l=27examen_pratique_d?= =?UTF-8?Q?u_permis_de_conduire?=')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody()
      .should('contain', centre.toUpperCase())
      .and('contain', '8:30')
    cy.mhHasMailWithSubject('=?UTF-8?Q?Annulation_de_votre_convocation_=C3=A0_l?= =?UTF-8?Q?=27examen?=')
    cy.mhDeleteAll()
    // Resend the confirmation
    cy.contains('Renvoyer ma convocation')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Votre convocation a été envoyée dans votre boîte mail.')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Convocation_=C3=A0_l=27examen_pratique_d?= =?UTF-8?Q?u_permis_de_conduire?=')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody()
      .should('contain', centre.toUpperCase())
      .and('contain', '8:30')
    // Cancels the reservation
    cy.contains('Annuler ma réservation')
      .click()
    cy.get('button')
      .contains('Confirmer')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Votre annulation a bien été prise en compte.')
    cy.get('h2')
      .should('contain', 'Choix du centre')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Annulation_de_votre_convocation_=C3=A0_l?= =?UTF-8?Q?=27examen?=')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody()
      .should('contain', centre.toUpperCase())
      .and('contain', '8:30')
    // Disconnects
    cy.contains('exit_to_app')
      .click()
    cy.url()
      .should('contain', 'candidat-presignup')
  })
})

describe('Admin front', () => {
  it('Searches for candidate, goes to the planning and disconnects', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    cy.get('h2')
      .should('contain', 'Tableau de bord')
    cy.get('h3')
      .should('contain', adminLogin.split('@')[0])
    // Searches for candidate
    cy.get('.t-search-candidat [type=text]')
      .type(candidat)
    cy.contains(candidat)
      .click()
    cy.get('h3')
      .should('contain', 'Informations candidats')
    cy.get('.t-result-candidat')
      .contains('Nom')
      .parent()
      .should('contain', candidat)
    // Searches for inspector
    cy.get('.t-search-inspecteur [type=text]')
      .type(inspecteur)
    cy.contains(inspecteur)
      .click()
    cy.get('h3')
      .should('contain', 'informations inspecteur')
    cy.get('.t-result-inspecteur')
      .contains('Nom')
      .parent()
      .should('contain', inspecteur)
    // Verifies the number of centers in 75 and 93
    cy.get('.layout.row.wrap').children()
      .should('have.length', 3)
    cy.get('.hexagon-wrapper').contains('93')
      .click()
    cy.get('.layout.row.wrap').children()
      .should('have.length', 4)
    cy.get('.hexagon-wrapper').contains('75')
      .click()
    // Goes to 07/10/2019 in the planning
    cy.get('h2.title')
      .should('contain', centre)
      .contains(centre)
      .parents('.monitor-wrapper').within(($centre) => {
        cy.contains('07 oct. 2019')
          .parents('tr').within(($row) => {
            cy.get('button').first()
              .within(($button) => {
                cy.get('.v-btn__content > :nth-child(3) > strong')
                  .invoke('text').as('placesDispo')
                cy.root().click()
              })
          })
      })
    cy.url()
      .should('contain', '2019-10-07')
    cy.get('.t-date-picker [type=text]').invoke('val')
      .should('contain', '07/10/2019')
    cy.get('.v-tabs__item--active')
      .should('contain', centre)
    // Verifies the number of places available
    cy.get('.v-window-item').not('[style="display: none;"]')
      .should('have.length', 1)
      .within(($window) => {
        cy.get('@placesDispo').then((placesDispo) => {
          cy.get('.place-button .v-icon:contains("check_circle")')
            .should('have.length', placesDispo)
        })
      })
    // Disconnects from the app
    cy.contains('exit_to_app')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes déconnecté·e')
    cy.url()
      .should('eq', candilibAddress + 'admin-login')
  })

  it('Adds and removes places', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // Goes to planning
    cy.contains('calendar_today').click()
    // Checks the center in the 93
    cy.get('.hexagon-wrapper').contains('93')
      .click()
    cy.get('.v-tabs__div')
      .should('contain', 'Bobigny')
    // Checks if the url matches the date displayed
    cy.get('.t-btn-next-week')
      .click()
    cy.url()
      .then(($url) => {
        let url = $url.split('/')
        let date = url[url.length - 1]
        let ymd = date.split('-')
        cy.get('.t-date-picker [type=text]').invoke('val')
          .should('contain', ymd[2] + '/' + ymd[1] + '/' + ymd[0])
      })
    // Goes to another date and checks the url
    cy.visit(candilibAddress + 'admin/gestion-planning/0/' + placeDate)
    cy.get('.hexagon-wrapper').contains('75')
      .click()
    cy.url()
      .then(($url) => {
        let url = $url.split('/')
        let date = url[url.length - 1]
        let ymd = date.split('-')
        cy.get('.t-date-picker [type=text]').invoke('val')
          .should('contain', ymd[2] + '/' + ymd[1] + '/' + ymd[0])
      })
    // Deletes the first place
    cy.get('.v-tabs')
      .contains(centre)
      .click({ force: true })
    cy.get('.v-window-item').not('[style="display: none;"]')
      .should('have.length', 1, { timeout: 10000 })
      .and('contain', inspecteur) // To ensure retry-ability
      .contains(inspecteur)
      .parents('tbody').within(($row) => {
        cy.get('.place-button')
          .contains('check_circle')
          .click()
        cy.contains('Rendre indisponible')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'a bien été supprimée de la base')
    // Add the first place
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur)
      .parents('tbody').within(($row) => {
        cy.get('.place-button')
          .contains('block')
          .click()
        cy.contains('Rendre le créneau disponible')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'a bien été crée')
    // Add candidate to the first place
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur)
      .parents('tbody').within(($row) => {
        cy.get('.place-button')
          .should('not.contain', 'block')
          .contains('check_circle')
          .click()
        cy.contains('Affecter un candidat')
          .click()
        cy.get('.search-input [type=text]')
          .type(candidat)
        cy.root().parents().contains(candidat)
          .click()
        cy.get('.place-details')
          .should('contain', centre)
        cy.contains('Valider')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', candidat)
      .and('contain', 'a bien été affecté à la place')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Convocation_=C3=A0_l=27examen_pratique_d?= =?UTF-8?Q?u_permis_de_conduire?=')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody()
      .should('contain', centre.toUpperCase())
    // Change the inspector
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur)
      .parents('tbody').within(($row) => {
        cy.get('.place-button')
          .contains('face')
          .click()
        cy.contains('Modifier l\'inspecteur')
          .click()
        cy.get('[type=text]')
          .type(inspecteur2 + '{enter}')
        cy.root()
          .should('contain', 'Vous avez choisi l\'inspecteur ' + inspecteur2)
        cy.get('button')
          .contains('Valider')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'La modification est confirmée.')
    // Add the place back
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur)
      .parents('tbody').within(($row) => {
        cy.get('.place-button')
          .contains('block')
          .click()
        cy.contains('Rendre le créneau disponible')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'a bien été crée')
    // Sends the mail for the inspectors
    cy.mhDeleteAll()
    cy.get('button')
      .contains('Envoyer les bordereaux aux inspecteurs du')
      .click()
    cy.get('.v-dialog')
      .contains('Envoyer les bordereaux aux inspecteurs du')
      .parents('.v-dialog')
      .find('[type=submit]')
      .contains('Envoyer')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Les emails ont bien été envoyés')
      .contains('close')
      .click()
    cy.mhGetAllMails()
      .should('have.length', 1)
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailInspecteur)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Bordereau_de_l=27inspecteur_')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody()
      .should('contain', centre)
      .and('contain', candidat)
    // Receive the mail for the inspectors
    cy.mhDeleteAll()
    cy.get('button')
      .contains('Recevoir les bordereaux des inspecteurs du')
      .click()
    cy.get('.v-dialog')
      .contains('Recevoir les bordereaux des inspecteurs du')
      .parents('.v-dialog')
      .should('contain', emailRepartiteur)
      .find('[type=submit]')
      .contains('Envoyer')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Les emails ont bien été envoyés')
      .contains('close')
      .click()
    cy.mhGetAllMails()
      .should('have.length', 1)
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailRepartiteur)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Bordereau_de_l=27inspecteur_')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody()
      .should('contain', centre)
      .and('contain', candidat)
    // Removes the candidate from the place
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur2)
      .parents('tbody').within(($row) => {
        cy.get('.place-button')
          .contains('face')
          .click()
        cy.contains('Annuler réservation')
          .click()
        cy.contains('Supprimer réservation')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'La réservation choisie a été annulée.')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Annulation_de_votre_convocation_=C3=A0_l?= =?UTF-8?Q?=27examen_par_l=27administration?=')
    // Add the place back
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur2)
      .parents('tbody').within(($row) => {
        cy.get('.place-button')
          .contains('block')
          .click()
        cy.contains('Rendre le créneau disponible')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'a bien été crée.')
  })
})

describe('Admin & Candidate interactions', () => {
  it('The candidate chooses a place and the admin cancels it', () => {
    cy.visit(magicLink)
    // Adds the reservation
    cy.get('h2')
      .should('contain', 'Choix du centre')
    cy.contains(centre)
      .click()
    cy.get('.v-tabs .primary--text')
      .click()
    cy.contains(' ' + placeDate.split('-')[2] + ' ')
      .parents('.v-list__group')
      .within(($date) => {
        cy.root().click()
        cy.contains('08h00-08h30')
          .click()
      })
    cy.get('h2')
      .should('contain', 'Confirmation')
    cy.get('h3')
      .should('contain', centre)
    cy.get('[type=checkbox]')
      .first().check({ force: true })
    cy.get('[type=checkbox]')
      .last().check({ force: true })
    cy.get('button')
      .contains('Confirmer')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Votre réservation a bien été prise en compte')
    cy.get('h2')
      .should('contain', 'Ma réservation')
    cy.get('h3')
      .should('contain', centre)
    cy.get('p')
      .should('contain', 'à 08:00')
    // Check candidate profile
    cy.contains('supervised_user_circle')
      .click()
    cy.contains('Nom de naissance')
      .parent().parent()
      .should('contain', candidat)
    // The admin connects
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // The admin find the reservation and cancels it
    cy.visit(candilibAddress + 'admin/gestion-planning/0/' + placeDate)
    cy.get('.v-tabs')
      .contains(centre)
      .click({ force: true })
    cy.get('.v-window-item').not('[style="display: none;"]')
      .should('have.length', 1)
      .and('contain', inspecteur) // To ensure retry-ability
      .within(($centre) => {
        cy.get('.place-button')
          .contains('face')
          .click()
        cy.get('.place-details')
          .should('contain', candidat)
        cy.contains('Annuler réservation')
          .click()
        cy.contains('Supprimer réservation')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'La réservation choisie a été annulée.')
    // Add the place back
    cy.get('.v-window-item').not('[style="display: none;"]')
      .within(($centre) => {
        cy.get('.place-button')
          .contains('block')
          .click()
        cy.contains('Rendre le créneau disponible')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'a bien été crée.')
    // The candidate doesn't have the reservation anymore
    cy.visit(magicLink)
    cy.get('h2')
      .should('contain', 'Choix du centre')
    // Check candidate profile
    cy.contains('supervised_user_circle')
      .click()
    cy.contains('Nom de naissance')
      .parent().parent()
      .should('contain', candidat)
  })

  it('The admin assigns a candidate and the candidate cancels it', () => {
    // Check the candidate
    cy.visit(magicLink)
    cy.get('h2')
      .should('contain', 'Choix du centre')
    cy.contains('supervised_user_circle')
      .click()
    cy.contains('Nom de naissance')
      .parent().parent()
      .should('contain', candidat)
    // The admin assigns the candidate to a place
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // Goes to planning
    cy.visit(candilibAddress + 'admin/gestion-planning/0/' + placeDate)
    cy.get('.v-tabs')
      .contains(centre)
      .click({ force: true })
    // Add candidate to the first place
    cy.get('.v-window-item').not('[style="display: none;"]')
      .should('have.length', 1)
      .and('contain', inspecteur) // To ensure retry-ability
      .contains(inspecteur)
      .parents('tbody').within(($row) => {
        cy.get('.place-button')
          .contains('check_circle')
          .click()
        cy.contains('Affecter un candidat')
          .click()
        cy.get('.search-input [type=text]')
          .type(candidat)
        cy.root().parents().contains(candidat)
          .click()
        cy.get('.place-details')
          .should('contain', centre)
        cy.contains('Valider')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', candidat)
      .and('contain', 'a bien été affecté à la place')
    // The candidate cancels the place
    cy.visit(magicLink)
    cy.get('h2')
      .should('contain', 'Ma réservation')
    cy.get('h3')
      .should('contain', centre)
    cy.get('p')
      .should('contain', 'à 08:00')
    cy.contains('Annuler ma réservation')
      .click()
    cy.get('button')
      .contains('Confirmer')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Votre annulation a bien été prise en compte.')
    cy.get('h2')
      .should('contain', 'Choix du centre')
    // The admin verifies that the reservation has been cancelled
    cy.visit(candilibAddress + 'admin/gestion-planning/0/' + placeDate)
    cy.get('.v-tabs')
      .contains(centre)
      .click({ force: true })
    cy.get('.v-window-item').not('[style="display: none;"]')
      .should('have.length', 1)
      .and('contain', inspecteur) // To ensure retry-ability
      .contains(inspecteur)
      .parents('tbody')
      .find('.place-button')
      .should('not.contain', 'face')
  })
})

describe('Additional tests', () => {
  it('Adds and removes from the whitelist', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // Visits the whitelist
    cy.visit(candilibAddress + 'admin/whitelist')
    cy.get('h2')
      .should('contain', 'Liste blanche')
    // Adds the email
    cy.contains('Ajouter une adresse courriel')
      .click()
    cy.get('.t-add-one-whitelist [type=text]')
      .type(email + '{enter}')
    cy.get('.v-snack')
      .should('contain', email + ' ajouté à la liste blanche')
    // Tries to add bad addresses
    cy.contains('Ajouter un lot d\'adresse courriel')
      .click()
    cy.get('#whitelist-batch-textarea')
      .type('test.com\ntest@.com\n@test.com\ntest@test\ntest@test.t\n')
    cy.contains('Enregistrer ces adresses')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Aucun email n\'a pu être ajouté à la liste blanche')
    cy.get('.t-whitelist-batch-result')
      .should('contain', 'Adresse invalide')
      .and('not.contain', 'Adresse courriel existante')
      .and('not.contain', 'Adresse enregistrée')
    // Add some addresses
    cy.contains('Ajouter un lot d\'adresse courriel')
      .click()
    cy.get('#whitelist-batch-textarea')
      .type('test@example.com\n' + email)
    cy.contains('Enregistrer ces adresses')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Certains emails n\'ont pas pu être ajoutés à la liste blanche')
    cy.get('.t-whitelist-batch-result')
      .should('contain', 'Adresse enregistrée')
      .and('contain', 'Adresse courriel existante')
      .and('not.contain', 'Adresse invalide')
    // Searches for the email
    cy.get('.search-input [type=text]')
      .type(email)
    cy.get('h4')
      .should('contain', 'Adresses correspondant à la recherche (max 5)')
    // Deletes the email
    cy.get('.t-whitelist-search')
      .contains(email)
      .parents('.t-whitelist-search')
      .contains('delete')
      .click()
    cy.get('.v-dialog')
      .should('contain', 'Voulez-vous vraiment supprimer l\'adresse ' + email + ' de la whitelist ?')
    cy.contains('Oui, supprimer')
      .click()
    cy.get('.v-snack')
      .should('contain', email + ' supprimé de la liste blanche')
      .contains('close')
      .click()
    // Deletes test@example.com
    cy.get('.whitelist-grid')
      .contains('test@example.com')
      .parents('[role="listitem"]')
      .should('contain', 'test@example.com')
      .contains('delete')
      .click()
    cy.get('.v-dialog')
      .should('contain', 'Voulez-vous vraiment supprimer l\'adresse test@example.com de la whitelist ?')
    cy.contains('Oui, supprimer')
      .click()
    cy.get('.v-snack')
      .should('contain', 'test@example.com supprimé de la liste blanche')
  })

  it('Tests the import of csv files in the planning', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // Goes to where the places are
    cy.visit(candilibAddress + 'admin/gestion-planning/0/' + placeDate)
    cy.get('.v-tabs')
      .contains(centre)
      .click({ force: true })
    // Removes the inspector's places
    cy.get('.v-window-item').not('[style="display: none;"]')
      .should('have.length', 1)
      .and('contain', inspecteur) // To ensure retry-ability
      .contains(inspecteur)
      .parents('tbody')
      .should('not.contain', 'block')
      .within(($row) => {
        // Removes the morning
        cy.contains('delete')
          .click()
        cy.contains('Supprimer la matinée')
          .click()
        cy.contains('Valider')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'La suppression des places sélectionnées a bien été effectuée')
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur2)
      .parents('tbody')
      .should('not.contain', 'block')
      .within(($row) => {
        // Removes the afternoon
        cy.contains('delete')
          .click()
        cy.contains('Supprimer l\'après-midi')
          .click()
        cy.contains('Valider')
          .click()
      })
    cy.get('.v-snack')
      .should('contain', 'La suppression des places sélectionnées a bien été effectuée')
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur2)
      .parents('tr').within(($row) => {
        cy.get(':nth-child(9)')
          .should('contain', 'check_circle')
        cy.get(':nth-child(10)')
          .should('contain', 'block')
      })
    cy.get('.v-window-item').not('[style="display: none;"]')
      .contains(inspecteur)
      .parents('tr')
      .within(($row) => {
        cy.get(':nth-child(9)')
          .should('contain', 'block')
        cy.get(':nth-child(10)')
          .should('contain', 'check_circle')
        // Removes the entire day
        cy.contains('delete')
          .click()
        cy.root().parent()
          .contains('Supprimer la journée')
          .click()
        cy.root().parent()
          .contains('Valider')
          .click()
      })
    // The inspector should not be present anymore
    cy.get('.name-ipcsr-wrap')
      .should('not.contain', inspecteur)
    // Imports the places
    cy.get('.t-import-places [type=checkbox]')
      .check({ force: true })
    const filePath = '../files/planning.csv'
    const fileName = 'planning.csv'
    cy.fixture(filePath).then(fileContent => {
      cy.get('[type=file]').upload({ fileContent, fileName, mimeType: 'text/csv' })
    })
    cy.get('.v-snack')
      .should('contain', 'planning.csv prêt à être synchronisé')
    cy.get('.import-file-action [type=button]')
      .click({ force: true })
    cy.get('.v-snack', { timeout: 10000 })
      .should('contain', 'Le fichier planning.csv a été traité pour le departement 75.')
    // The inspector should be back
    cy.contains('replay')
      .click()
    cy.get('.name-ipcsr-wrap')
      .should('contain', inspecteur)
  })

  it('Logins with a restricted admin account', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type('admin93@example.com')
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    cy.get('.hexagon-wrapper')
      .should('not.contain', '75')
      .and('contain', '93')
    cy.get('h3')
      .should('contain', 'admin93')
    cy.get('.title')
      .should('contain', 'Bobigny')
    cy.get('.v-toolbar')
      .should('not.contain', 'import_export')
    cy.contains('calendar_today').click()
    cy.get('.v-tabs__div')
      .should('contain', 'Bobigny')
  })

  it('Tries the admin login with an invalid password', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass + 'bad')
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Identifiants invalides')
  })

  it('Tries the admin login with an invalid email', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type('admin@example')
    cy.get('[type=password]')
      .type('password')
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Veuillez remplir le formulaire')
  })

  it('Tries the already signed up form without account', () => {
    cy.visit(candilibAddress + 'qu-est-ce-que-candilib')
    cy.get('.t-already-signed-up-button-top')
      .should('contain', 'Déjà Inscrit ?')
      .click()
    cy.get('.t-magic-link-input-top [type=text]')
      .type(email)
    cy.get('.t-magic-link-button-top')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Utilisateur non reconnu')
  })

  it('Tries to pre-signup with a not whitelisted address', () => {
    cy.visit(candilibAddress + 'qu-est-ce-que-candilib')
    cy.contains('Se pré-inscrire')
      .click()
    cy.get('h2')
      .should('contain', 'Réservez votre place d\'examen')
    cy.contains('NEPH')
      .parent()
      .children('input')
      .type('0123456789')
    cy.contains('Nom de naissance')
      .parent()
      .children('input')
      .type(candidat)
    cy.contains('Prénom')
      .parent()
      .children('input')
      .type('Jean')
    cy.contains('Courriel *')
      .parent()
      .children('input')
      .type('badtest@example.com')
    cy.contains('Portable')
      .parent()
      .children('input')
      .type('0716253443')
    cy.contains('Adresse')
      .parent()
      .children('input')
      .type('avenue')
    cy.get('.v-select-list')
      .contains('avenue')
      .click()
    cy.contains('Pré-inscription')
      .click()
    cy.get('.v-snack')
      .should('contain', 'L\'adresse courriel renseignée (badtest@example.com) n\'est pas dans la liste des invités.')
    // Goes to the 'Mentions Légales' page
    cy.contains('Mentions légales')
      .click()
    cy.url()
      .should('contain', 'mentions-legales')
    cy.get('h2')
      .should('contain', 'Mentions légales')
    cy.contains('exit_to_app')
      .click()
    cy.get('h2')
      .should('contain', 'Réservez votre place d\'examen')
    // Tests the display of the F.A.Q.
    cy.contains('Une question')
      .click()
    cy.url()
      .should('contain', 'faq')
    cy.get('h2')
      .should('contain', 'F.A.Q')
    cy.get('.question-content')
      .should('not.be.visible')
    cy.get('.question').contains('?')
      .click()
    cy.get('.question-content')
      .should('be.visible')
  })

  it('Validation refused for outdated ETG', () => {
    cy.visit(candilibAddress + 'qu-est-ce-que-candilib')
    cy.contains('Se pré-inscrire')
      .click()
    cy.get('h2')
      .should('contain', 'Réservez votre place d\'examen')
    cy.contains('NEPH')
      .parent()
      .children('input')
      .type('093621795384')
    cy.contains('Nom de naissance')
      .parent()
      .children('input')
      .type('GOOSE')
    cy.contains('Prénom')
      .parent()
      .children('input')
      .type('JIM')
    cy.contains('Courriel *')
      .parent()
      .children('input')
      .type('jimgoose@candilib.com')
    cy.contains('Portable')
      .parent()
      .children('input')
      .type('0716253443')
    cy.contains('Adresse')
      .parent()
      .children('input')
      .type('avenue')
    cy.get('.v-select-list')
      .contains('avenue')
      .click()
    cy.contains('Pré-inscription')
      .click()
    // Verifies the access
    cy.url()
      .should('contain', 'email-validation')
    cy.get('h3')
      .should('contain', 'Validation en attente')
    cy.get('div')
      .should('contain', 'Vous allez bientôt recevoir un courriel à l\'adresse que vous nous avez indiqué.')
    cy.contains('Retour au formulaire de pré-inscription')
      .click()
    // Gets the confirmation email from mailHog
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', 'jimgoose@candilib.com')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', 'Validation d\'adresse email pour Candilib')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetBody().then((mailBody) => {
        const codedLink = mailBody.split('href=3D"')[1].split('">')[0]
        const withoutEq = codedLink.replace(/=\r\n/g, '')
        const validationLink = withoutEq.replace(/=3D/g, '=')
        cy.visit(validationLink)
      })
    cy.get('h3')
      .should('contain', 'Adresse courriel validée')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', 'jimgoose@candilib.com')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Inscription_Candilib_en_attente_de_v?= =?UTF-8?Q?=C3=A9rification?=')
    // Aurige invalidate the user
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // Goes to the page
    cy.contains('import_export')
      .click()
    // Uploads the JSON file
    const filePath = '../files/aurige.json'
    const fileName = 'aurige.json'
    cy.fixture(filePath).then(fileContent => {
      cy.get('.input-file-container [type=file]')
        .upload({
          fileContent: JSON.stringify(fileContent),
          fileName,
          mimeType: 'application/json',
        })
    })
    cy.get('.v-snack')
      .should('contain', 'aurige.json prêt à être synchronisé')
    cy.get('.import-file-action [type=button]')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Le fichier aurige.json a été synchronisé.')
    // Verifies the error message
    cy.get('.ag-cell')
      .should('contain', 'Pour le 75, ce candidat jimgoose@candilib.com sera archivé : Date ETG KO')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', 'jimgoose@candilib.com')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Probl=C3=A8me_inscription_Candilib?=')
  })
})

describe('Teardown', () => {
  it('Archives the candidate from the db', () => {
    cy.visit(candilibAddress + 'admin-login')
    cy.get('[type=text]')
      .type(adminLogin)
    cy.get('[type=password]')
      .type(adminPass)
    cy.get('.submit-btn')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Vous êtes identifié')
    // Goes to the page
    cy.contains('import_export')
      .click()
    // Uploads the JSON file
    const filePath = '../files/aurige.end.json'
    const fileName = 'aurige.json'
    cy.fixture(filePath).then(fileContent => {
      cy.get('.input-file-container [type=file]')
        .upload({
          fileContent: JSON.stringify(fileContent),
          fileName,
          mimeType: 'application/json',
        })
    })
    cy.get('.v-snack')
      .should('contain', 'aurige.json prêt à être synchronisé')
    cy.get('.import-file-action [type=button]')
      .click()
    cy.get('.v-snack')
      .should('contain', 'Le fichier aurige.json a été synchronisé.')
    // Verifies the error message
    cy.get('.ag-cell')
      .should('contain', candidat + ' sera archivé : NEPH inconnu')
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetRecipients()
      .should('contain', emailCandidat)
    cy.mhGetAllMails()
      .mhFirst()
      .mhGetSubject()
      .should('contain', '=?UTF-8?Q?Inscription_Candilib_non_valid=C3=A9e?=')
  })
})
